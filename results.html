<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Screener Results</title>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --york-red:#E31837; --york-red-dark:#AF0D1A;
      --ink:#111; --muted:#6b7280; --bg:#FAFAFA; --card:#fff; --border:#E8E6E4; --focus:#3AC2EF; --neutral:#9ca3af;
      --soft:#fff5f6; --soft-border:#ffd9de;
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:var(--bg);color:var(--ink);
      font-family:"IBM Plex Sans",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      padding:40px 16px;display:grid;place-items:start center
    }
    .wrap{width:100%;max-width:860px}
    .hero{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;box-shadow:0 10px 24px rgba(17,17,17,.06)}
    .badge{display:inline-flex;align-items:center;gap:8px;background:var(--soft);color:var(--york-red);border:1px solid var(--soft-border);border-radius:999px;padding:6px 12px;font-weight:700;font-size:12px;letter-spacing:.02em;margin-bottom:10px}
    h1{margin:0 0 4px 0;font-size:clamp(24px,3.6vw,34px);letter-spacing:-.01em}

    .stack{display:grid;gap:16px;margin-top:18px}
    .card{border:1px solid var(--border);border-radius:12px;padding:16px;background:#fff}
    .head{display:flex;align-items:baseline;justify-content:space-between;gap:12px}
    .title{font-size:18px;font-weight:700;margin:0}
    .sr-only{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    /* Pills + risk lines */
    .pill{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;font-weight:700;font-size:12px;border:1px solid transparent;min-height:44px}
    .pill.high{color:#fff;background:var(--york-red)}
    .pill.mod{color:#111;background:#fde68a;border-color:#fcd34d}
    .pill.ok{color:#374151;background:#f3f4f6;border-color:#e5e7eb}
    .riskline{display:flex;align-items:center;gap:10px;margin-top:8px;min-height:40px}

    /* Notice */
    .ephemeral{border:1px dashed var(--border);border-radius:10px;padding:10px 12px;font-size:13px;color:#7a1b25;background:#fff6f7;margin:10px 0 14px 0}

    /* Horizontal chart */
    .chart-wrap{margin-top:12px}
    .chart-box{border:1px solid var(--border);border-radius:12px;padding:8px 12px;overflow:hidden;min-height:128px}
    .chart-box > div{min-height:108px}

    /* Dropdown arrows */
    details{margin-top:10px}
    summary{
      cursor:pointer;font-weight:600;min-height:44px;display:flex;align-items:center;
      list-style:none;
    }
    summary::before{
      content:"▸"; display:inline-block;
      font-size:22px; font-weight:700; color:#333;
      width:1.2em; margin-right:8px;
      transition:transform .2s ease;
    }
    details[open] summary::before{ transform:rotate(90deg); }

    .list{margin:10px 0 0;padding-left:18px}
    .btns{display:flex;gap:10px;margin-top:16px;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer;min-height:44px}
    .btn.primary{background:var(--york-red);color:#fff;border-color:transparent}
    .btn:focus-visible{outline:3px solid var(--focus);outline-offset:2px}
    .print-note{font-size:12px;color:var(--muted)}

    /* "More info" placeholder link */
    .more-info{
      margin-left:auto; font-size:13px; font-weight:700; color:var(--york-red); text-decoration:none;
    }
    .more-info:hover{ text-decoration:underline; }
    .more-info:focus-visible{ outline:3px solid var(--focus); outline-offset:2px; }

    footer{margin-top:14px;text-align:center;font-size:13px;color:var(--muted)}

    /* Summary (blurb only) */
    .summary{display:grid;gap:12px;min-height:80px}
    .summary-head{display:flex;align-items:center;gap:12px}
    #summaryBlurb{min-height:48px;display:flex;align-items:center;font-size:14px}
    .summary-note{font-size:12px;color:#6b7280}

    /* Print */
    .print-only{display:none}
    @media print{
      @page{ margin:16mm }
      body{ background:#fff; padding:0 }
      .btns, .badge{ display:none !important }
      .hero{ box-shadow:none; border:0; padding:0 }
      .print-only{ display:block !important }
      .chart-box{ border:1px solid #000 }
      .cut-label, .score-label{ fill:#000 !important }
      .ephemeral{ border-color:#000; background:#fff; color:#000 }
    }
  </style>
</head>
<body>
  <main class="wrap" role="main">
    <section class="hero">
      <div class="badge" aria-hidden="true">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3l7 3v6c0 5-3.5 8-7 9-3.5-1-7-4-7-9V6l7-3z" stroke="currentColor" stroke-width="1.5" fill="none"></path><path d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></path></svg>
        York-Simcoe Sex Trafficking Screener (YST)
      </div>
      <h1>Screener Results</h1>

      <div class="ephemeral" role="note" aria-live="polite">
        <strong>Results are not saved.</strong> Print/save a PDF or record outcomes per agency procedure before leaving or refreshing. Use the button at the bottom of the page.
      </div>

      <!-- Summary -->
      <div class="card summary" id="summaryCard" aria-labelledby="summaryTitle">
        <div class="summary-head">
          <h2 class="title" id="summaryTitle" style="margin:0;">Summary</h2>
          <a class="more-info" href="/docs/yst-interpretation.pdf" target="_blank" rel="noopener">More info</a>
        </div>

        <div id="printMeta" class="print-only" style="font-size:12px;color:#333;margin-bottom:6px;"></div>

        <div id="summaryBlurb"></div>
        <div class="summary-note">Use clinical judgement and local safety procedures. Scores support—do not replace—professional decision-making.</div>
      </div>

      <div class="stack">
        <!-- Factor 1 -->
        <div class="card">
          <div class="head">
            <h2 class="title">ST Exploitation Warning Signs</h2>
            <span id="f1Nums" class="sr-only" aria-live="polite"></span>
          </div>
          <div class="riskline" id="f1RiskLine"><span class="pill" id="f1Pill">Loading…</span></div>

          <div class="chart-wrap" aria-label="Exploitation visual indicator">
            <div class="chart-box"><div id="f1Chart"></div></div>
          </div>

          <details open>
            <summary>Confirmed risk items</summary>
            <ul class="list" id="f1List"></ul>
          </details>
        </div>

        <!-- Factor 2 -->
        <div class="card">
          <div class="head">
            <h2 class="title">ST Recruitment Warning Signs</h2>
            <span id="f2Nums" class="sr-only" aria-live="polite"></span>
          </div>
          <div class="riskline" id="f2RiskLine"><span class="pill" id="f2Pill">Loading…</span></div>

          <div class="chart-wrap" aria-label="Recruitment visual indicator">
            <div class="chart-box"><div id="f2Chart"></div></div>
          </div>

          <details open>
            <summary>Confirmed risk items</summary>
            <ul class="list" id="f2List"></ul>
          </details>
        </div>

        <!-- Combined No Info / Maybe -->
        <div class="card">
          <details>
            <summary>Items marked “No Info” or “Maybe” (investigate)</summary>
            <ul class="list" id="niCombined"></ul>
          </details>
        </div>

        <div class="btns">
          <button class="btn primary" id="printBtn">Print / Save PDF</button>
          <span class="print-note">Tip: expand dropdowns before printing so all items appear on the PDF.</span>
        </div>
      </div>
    </section>

    <footer>
      <small>
        Developed by the Teen Relationships Lab at York University in partnership with York Region CAS and Simcoe-Muskoka Family Connexions.<br>
        © 2025 Teen Relationships Lab, York University. No distribution of this tool outside your agency.
      </small>
    </footer>
  </main>

  <script>
    // ---------- Data ----------
    const F1_IDS = ['yst5b_sxl_prtn','yst5c_nn_dscls','yst5d_stis','yst5_ldr_prtnr','yst5f_bsv_prtn','yst7_cnnctns_x','yst7b_gang','yst7d_trffckn_','yst7e_hides_nf','yst8b_trnsprtt','yst8d_ntrnt_bh','yst8_trffckng','yst8f_awol','yst8h_id','yst8_rprts_sx','yst9_csh_nd_gd','yst9b_hotels','yst9c_cll_phns'];
    const F2_IDS = ['yst1f_fnncll__','yst3a_sexul_bs','yst4_crgrvr_spr','yst4_pr_rltnsh','yst6c_fearful','yst6d_self_hrm','yst7f_neds_nmt','yst8c_schl_ttn','yst7c_xpsd_dr_','yst8a_sbstnc_s','yst1h_jstc_sys','yst6g_physcl_t','yst8g_housing','yst6f_chngd_pp'];

    // ---------- NEW cut-offs (percentile bands) ----------
    // Exploitation: <5 Low, 5–10 Slightly Elevated, 11–16 Elevated, ≥17 Very Elevated
    // Recruitment:  <7 Low, 7–10 Slightly Elevated, 13–19 Elevated, ≥20 Very Elevated
    const CUTS = {
      f1: { lowMax: 4, slightMin: 5, elevMin: 11, veryMin: 17, max: F1_IDS.length*3 },
      f2: { lowMax: 6, slightMin: 7, elevMin: 13, veryMin: 20, max: F2_IDS.length*3 }
    };

    // Treat "1" as No Info by default
    const TREAT_ONE_AS_NI = localStorage.getItem('YST_TREAT_ONE_AS_NI') !== '0';
    const niRegex = /^(ni|no[\s_]?info|no[-\s]?information|unsure|unknown)$/i;

    // Labels (unchanged)
    const LABELS = {
      yst5b_sxl_prtn:"Youth has had multiple sexual partners in the last year (4 or more)",
      yst5c_nn_dscls:"Youth is non-disclosing when it comes to sharing about their romantic partner",
      yst5d_stis:"Youth has been treated or tested for having multiple STIs/UTIs (e.g., kidney infections)",
      yst5_ldr_prtnr:"Youth has romantic partners who are significantly older (e.g., significant age gap between youth and romantic partner—4 or more years).",
      yst5f_bsv_prtn:"Youth has been exposed to an abusive or controlling intimate partner",
      yst7_cnnctns_x:"Youth is connected to people who are exploited (i.e., trafficked), who buy or sell sex or who are known/suspected to be sex traffickers.",
      yst7b_gang:"Youth has gang affiliation/contact (e.g., tattoos suggestive of branding or gang insignia).",
      yst7d_trffckn_:"Youth spends time in locations that are known as venues for sex trafficking (e.g., physical or online spaces where youth congregate without caregiver supervision).",
      yst7e_hides_nf:"Youth’s answers to questions about their age, whereabouts, residence, or relationships are vague or misleading.",
      yst8b_trnsprtt:"Youth hitch-hikes or travels in cars with unknown individuals (e.g., receives or solicits drives from unknown individuals/strangers, has Ubers sent to them, has a driver).",
      yst8d_ntrnt_bh:"Youth engages in concerning internet behaviour (e.g., posting, “sexting”, chatting or meeting  with strangers online possibly for sexual purposes, has been watched, filmed, or photographed in a sexually explicit manner).",
      yst8_trffckng:"Youth uses language related to sex trafficking (e.g., “the game”)",
      yst8f_awol:"Youth runs away/is gone and their whereabouts are unknown (e.g., for long periods of time, frequently for short durations, unexplained absence).",
      yst8h_id:"Someone else is controlling the youth’s ID documents and/or contact with family or friends, leaving the youth socially isolated (i.e., controlling cell phone and social media use).",
      yst8_rprts_sx:"Youth reports exchanging sex for money or material goods",
      yst9_csh_nd_gd:"Youth has large amounts of unexplained cash, or expensive items (e.g., new purses, shoes, technical devices, gift cards, groceries being assisted by strangers).",
      yst9b_hotels:"Youth frequents hotel rooms and/or has hotel key cards in their possession.",
      yst9c_cll_phns:"Youth has several cell phones",
      yst1f_fnncll__:"Youth is financially stable (e.g., has stable housing, caregiver is able to provide, children, pets, family obligations are met, is not being forced to give their money to someone)",
      yst3a_sexul_bs:"Youth has experienced sexual abuse",
      yst4_crgrvr_spr:"Parent/caregiver is unable to provide adequate supervision",
      yst4_pr_rltnsh:"Youth has peer relationships that appear unsafe (e.g., peers who are a negative influence, significantly older peers, unstable peer group) and/or experiences social exclusion.",
      yst6c_fearful:"Youth appears on edge, preoccupied with safety, or hypervigilant.",
      yst6d_self_hrm:"Youth presents with self-harming behaviour and/or expresses suicidal ideation (i.e., thoughts about dying or ending life)",
      yst7f_neds_nmt:"Youth describes basic needs as being unmet (e.g., financially and/or emotionally)",
      yst8c_schl_ttn:"Youth has sporadic school attendance (e.g., skips multiple days or is not attending, attends to solicit other youth).",
      yst7c_xpsd_dr_:"Youth is exposed to drugs/alcohol, and/or the buying and selling of drugs.",
      yst8a_sbstnc_s:"Youth presents with substance use difficulties (e.g., appears to be under the influence, found with alcohol/drugs)",
      yst1h_jstc_sys:"Youth has past or current involvement with the justice system (e.g., contact with police, involvement with criminal activities)",
      yst6g_physcl_t:"Youth shows signs of physical trauma (e.g., black eyes, cigarette burns, or broken bones)",
      yst8g_housing:"Youth lives outside of family/caregiver home (e.g., stays overnight at friends for extended time, periods of homelessness, unstable housing, with a boy/girlfriend), lives independently and/or is being housed by someone who is paying for their living expenses.",
      yst6f_chngd_pp:"Youth presents a significant and sudden change in appearance (e.g., dress, hygiene, weight, tattoos)"
    };

    // ---------- Helpers ----------
    function getStored(id){
      const raw = localStorage.getItem(id);
      if (raw === null) return null;
      const num = parseInt(raw, 10);
      return isNaN(num) ? raw : num;
    }
    function sum(ids){
      return ids.reduce((acc,id)=>{
        const v = parseInt(localStorage.getItem(id) || '0', 10);
        if (isNaN(v)) return acc;
        if (TREAT_ONE_AS_NI && v === 1) return acc; // ignore "No Info"
        return acc + v;
      },0);
    }

    // Confirmed (Yes only)
    function buildConfirmedList(ids){
      const out = [];
      ids.forEach(id=>{
        const stored = parseInt(localStorage.getItem(id) || '0', 10);
        if (!isNaN(stored) && stored === 3){ out.push({ id }); }
      });
      return out;
    }

    // No Info / Maybe combined
    function isNoInfo(id){
      const flag = localStorage.getItem(id + '_ni') === '1' || localStorage.getItem('ni_' + id) === '1';
      const val = getStored(id);
      if (flag) return true;
      if (val === null) return false;
      if (typeof val === 'number') return (TREAT_ONE_AS_NI && val === 1) || val === 2;
      return niRegex.test(String(val));
    }
    function buildCombinedNI(idsA, idsB){ return [...idsA, ...idsB].filter(id => isNoInfo(id)); }

    // ---------- New band calculators ----------
    function bandF1(score){
      if (score >= CUTS.f1.veryMin) return 'Very Elevated Risk';
      if (score >= CUTS.f1.elevMin) return 'Elevated Risk';
      if (score >= CUTS.f1.slightMin) return 'Slightly Elevated Risk';
      return 'Low Risk';
    }
    function bandF2(score){
      if (score >= CUTS.f2.veryMin) return 'Very Elevated Risk';
      if (score >= CUTS.f2.elevMin) return 'Elevated Risk';
      if (score >= CUTS.f2.slightMin) return 'Slightly Elevated Risk';
      return 'Low Risk';
    }

    // ---------- Riskline pill (no sentence, just band name) ----------
    function setRiskLine(containerId, pillId, band){
      const pill = document.getElementById(pillId);
      pill.className = 'pill ' + (
        band === 'Very Elevated Risk' || band === 'Elevated Risk' ? 'high' :
        band === 'Slightly Elevated Risk' ? 'mod' : 'ok'
      );
      pill.textContent = band;
    }

    /* ---------- Bar charts with 50+/75+/90+ and “Your score” pill ---------- */
    function drawBar({containerId, value, max, cutValues=[]}){
      const w = 520, h = 108, pad = 14;
      const usableW = w - pad*2;
      const clamp = n => Math.max(0, Math.min(n, max));
      const v = clamp(value);
      const barY = h/2 - 18, barH = 24;

      const scoreX = pad + (v/max)*usableW;

      // Score pill placement
      const PILL_W = 86, PILL_H = 22, EDGE_PAD = 8;
      const UNDER_Y = barY + barH + 10;
      const OVER_Y  = barY - PILL_H - 12;
      let pillX = scoreX - PILL_W/2;
      if (pillX < pad + EDGE_PAD) pillX = pad + EDGE_PAD;
      if (pillX + PILL_W > w - pad - EDGE_PAD) pillX = w - pad - EDGE_PAD - PILL_W;
      const tooCloseToCut = cutValues.some(c => Math.abs(scoreX - (pad + (c/max)*usableW)) < 36);
      const pillY = tooCloseToCut ? OVER_Y : UNDER_Y;

      // Build cut lines + labels (50+/75+/90+)
      const cutSvg = cutValues.map((cVal, i) => {
        const cx = pad + (cVal/max)*usableW;
        const label = i===0 ? '50+' : i===1 ? '75+' : '90+';
        return `
          <line x1="${cx}" y1="${barY-10}" x2="${cx}" y2="${barY+barH+10}" stroke="#111" stroke-width="2"/>
          <text class="cut-label" x="${cx}" y="${barY-14}" text-anchor="middle" font-size="11" fill="#111">${label}</text>
        `;
      }).join("");

      const svg = `
        <svg width="100%" viewBox="0 0 ${w} ${h}" role="img" aria-label="Percentile cut-offs and your score marker">
          <rect x="${pad}" y="${barY}" width="${usableW}" height="${barH}" rx="12" fill="#f3f4f6" stroke="#e5e7eb"/>
          <rect x="${pad}" y="${barY}" width="${(v/max)*usableW}" height="${barH}" rx="12" fill="var(--york-red)" opacity="0.15"/>
          ${cutSvg}
          <line x1="${scoreX}" y1="${barY-10}" x2="${scoreX}" y2="${barY+barH+10}" stroke="var(--york-red-dark)" stroke-width="2" stroke-dasharray="3 3"/>
          <foreignObject x="${pillX}" y="${pillY}" width="${PILL_W}" height="${PILL_H+10}">
            <div xmlns="http://www.w3.org/1999/xhtml"
                 style="display:inline-flex;align-items:center;justify-content:center;
                        width:${PILL_W}px;height:${PILL_H}px;
                        background:#fff5f6;border:1px solid #ffd9de;border-radius:999px;
                        font:600 12px 'IBM Plex Sans', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
                        color:var(--york-red-dark);line-height:1;">
              Your score
            </div>
          </foreignObject>
        </svg>`;
      document.getElementById(containerId).innerHTML = svg;
    }

    function drawHorizontalBarF1(containerId, value, max){
      drawBar({
        containerId, value, max,
        cutValues:[CUTS.f1.slightMin, CUTS.f1.elevMin, CUTS.f1.veryMin]
      });
    }
    function drawHorizontalBarF2(containerId, value, max){
      drawBar({
        containerId, value, max,
        cutValues:[CUTS.f2.slightMin, CUTS.f2.elevMin, CUTS.f2.veryMin]
      });
    }

    // ---------- Verbatim summary blurbs from PDF ----------
    // NOTE: text copied exactly (punctuation/wording preserved). filecite turn2file0
    const VERBATIM = {
      expoVE: "This youth is presenting with a significant number of exploitation warning signs placing them at a very elevated risk of sex trafficking involvement. Please follow agency guidelines and seek immediate support for the youth.",
      expoE:  "This youth is presenting with a significant number of exploitation warning signs placing them at an  elevated risk of sex trafficking involvement. Please follow agency guidelines and seek immediate support for the youth.",
      bothHighSig: "This youth is presenting with a high number of  exploitation warning signs and a significant number of recruitment warning signs placing them at risk of sex trafficking involvement. Please follow agency guidelines and seek immediate support for the youth.",
      bothHighHigh: "This youth is presenting with a high number of  exploitation warning signs and a high number of  recruitment warning signs placing them at risk of sex trafficking involvement. Please follow agency guidelines and seek immediate support for the youth.",
      highExpoLowRec: "This youth is presenting with a high number of  exploitation warning signs and a low number of  recruitment warning signs placing them at risk of sex trafficking involvement. Please follow agency guidelines ensure immediate follow-up with the youth  and implement support.",
      recVE: "This youth is presenting with a significant number of recruitment warning signs placing them at a very elevated  risk of sex trafficking recruitment. Please follow agency guidelines to ensure immediate follow-up with the youth and take steps to prevent further recruitment risk",
      recE:  "This youth is presenting with a significant number of recruitment warning signs placing them at an elevated risk of sex trafficking recruitment. Please follow agency guidelines to ensure immediate follow-up with the youth and take steps to prevent further recruitment risk",
      recSlight: "This youth is presenting with a high number of recruitment warning signs placing them at risk of sex trafficking recruitment. Please follow agency guidelines to ensure immediate follow-up with the youth and take steps to prevent further recruitment risk.",
      bothLow: "This youth is presenting with a low number of  exploitation and recruitment warning signs placing them at low risk of sex trafficking involvement and recruitment. Continue to monitor for any indicators, and use your clinical judgment. Note that a low score does not rule out risk; youth may still present concerning indicators or circumstances requiring attention."
    };

    // Choose the correct blurb based on new rules
    function chooseSummary(f1, f2){
      // Primary: Exploitation Very Elevated / Elevated
      if (f1 >= CUTS.f1.veryMin) return VERBATIM.expoVE;
      if (f1 >= CUTS.f1.elevMin) return VERBATIM.expoE;

      // Combinations where exploitation is "high" (i.e., ≥5)
      if (f1 >= CUTS.f1.slightMin && f2 >= CUTS.f2.elevMin) return VERBATIM.bothHighSig;
      if (f1 >= CUTS.f1.slightMin && f2 >= CUTS.f2.slightMin) return VERBATIM.bothHighHigh;
      if (f1 >= CUTS.f1.slightMin && f2 <= CUTS.f2.lowMax)  return VERBATIM.highExpoLowRec;

      // Recruitment-led cases when exploitation is low
      if (f1 <= CUTS.f1.lowMax && f2 >= CUTS.f2.veryMin) return VERBATIM.recVE;
      if (f1 <= CUTS.f1.lowMax && f2 >= CUTS.f2.elevMin) return VERBATIM.recE;
      if (f1 <= CUTS.f1.lowMax && f2 >= CUTS.f2.slightMin) return VERBATIM.recSlight;

      // Both low
      return VERBATIM.bothLow;
    }

    // ---------- Render ----------
    function fillConfirmed(ids, ulId){
      const ul = document.getElementById(ulId);
      ul.innerHTML = '';
      const items = buildConfirmedList(ids);
      if (!items.length){ ul.innerHTML = '<li>No items to display.</li>'; return; }
      items.forEach(({id})=>{
        const li = document.createElement('li');
        li.textContent = LABELS[id] || id;
        ul.appendChild(li);
      });
    }

    function fillCombinedNI(ulId){
      const ul = document.getElementById(ulId);
      ul.innerHTML = '';
      const items = buildCombinedNI(F1_IDS, F2_IDS);
      if (!items.length){ ul.innerHTML = '<li>No “No Info” or “Maybe” items.</li>'; return; }
      items.forEach(id=>{
        const li = document.createElement('li');
        li.textContent = LABELS[id] || id;
        ul.appendChild(li);
      });
    }

    function render(){
      const dt=new Date();
      const stamp=dt.toLocaleString(undefined,{dateStyle:'medium', timeStyle:'short'});
      document.getElementById('printMeta').textContent = `Screened on ${stamp} • This printout is generated from a device-only session.`;

      const f1 = sum(F1_IDS), f2 = sum(F2_IDS);
      const f1Max = CUTS.f1.max, f2Max = CUTS.f2.max;

      // Factor pills with new bands
      document.getElementById('f1Nums').textContent = 'Exploitation bar with 50+/75+/90+ markers and your score.';
      document.getElementById('f2Nums').textContent = 'Recruitment bar with 50+/75+/90+ markers and your score.';
      setRiskLine('f1RiskLine','f1Pill', bandF1(f1));
      setRiskLine('f2RiskLine','f2Pill', bandF2(f2));

      // Charts with 3 cut-offs + score pill
      drawHorizontalBarF1('f1Chart', f1, f1Max);
      drawHorizontalBarF2('f2Chart', f2, f2Max);

      // Summary (PDF text verbatim)
      document.getElementById('summaryBlurb').textContent = chooseSummary(f1, f2);

      // Lists
      fillConfirmed(F1_IDS,'f1List');
      fillConfirmed(F2_IDS,'f2List');
      fillCombinedNI('niCombined');
    }

    function clearKeys(){
      [...F1_IDS,...F2_IDS,'factor1_score','factor2_score'].forEach(k=>localStorage.removeItem(k));
    }

    document.getElementById('printBtn').addEventListener('click',()=>window.print());
    render();
    window.addEventListener('pagehide',clearKeys);
    window.addEventListener('beforeunload',clearKeys);

    // Offline-friendly
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js', { scope: '/' }).catch(()=>{});
      });
    }
  </script>
</body>
</html>
